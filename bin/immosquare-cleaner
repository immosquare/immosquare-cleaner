#!/usr/bin/env ruby

require "immosquare-cleaner"
require "optparse"
require "digest"

##============================================================##
## Prevent "invalid byte sequence in US-ASCII" error on some files (eg: yaml)
##============================================================##
Encoding.default_external = Encoding::UTF_8

##============================================================##
## We check if bun.sh is installed
##============================================================##
def bun_installed?
  system("which bun > /dev/null 2>&1")
end

if !bun_installed?
  puts("Error: 'bun' is not installed. Please install it first.(https://bun.sh/)")
  exit(1)
end


options = {}
##============================================================##
## optparse is a standard library of ruby, it's used to parse command line
##============================================================##
OptionParser.new do |parser|
  parser.banner = "Usage: immosquare-cleaner [options] file"
  parser.on("-p", "--prevent-concurrent-write", "Prevent concurrent write") do
    options[:prevent_concurrent_write] = true
  end
  parser.on("-h", "--help", "Prints this help") do
    puts(parser)
    exit
  end
end.parse!

##============================================================##
## Check if the file path is provided
##============================================================##
file_path = ARGV[0]
if !file_path
  puts("Error: Please provide a file path.")
  exit(1)
end

##============================================================##
## Check if the file exists
##============================================================##
if !File.exist?(file_path)
  puts("Error: The file '#{file_path}' does not exist.")
  exit(1)
end

##============================================================##
## Check if node_modules exists, if not we launch bun install
##============================================================##
gem_root            = File.expand_path("..", __dir__)
node_modules_folder = File.join(gem_root, "node_modules")
if !File.directory?(node_modules_folder)
  puts("node_modules folder not found, running 'bun install'")
  output = `cd #{gem_root} && bun install`
  if $CHILD_STATUS.exitstatus != 0
    puts("Error: 'bun install' failed.")
    puts(output)
    exit(1)
  end
end

##============================================================##
## We can now call the clean method, passing the file absolute path and options
##============================================================##
file_path = File.expand_path(file_path)
if options[:prevent_concurrent_write]
  ##============================================================##
  ## concurrent write detection
  ## wait 2s for the ide to do a pre-processing, then 3 cases :
  ## - if the original file changed during the clean, give up
  ## - if the cleaned file has the same checksum, do nothing
  ## - else, erase the original file with the cleaned one
  ##============================================================##
  sleep(2)
  before    = Digest::MD5.file(file_path)
  temp_path = "/tmp/#{file_path}"
  FileUtils.mkdir_p(File.dirname(temp_path))
  FileUtils.copy(file_path, temp_path)
  ImmosquareCleaner.clean(temp_path, **options)
  if Digest::MD5.file(file_path) != before
    puts("Original file has changed, giving up cleaning.")
  elsif Digest::MD5.file(temp_path) == before
    puts("Cleaner had nothing to do, moving on.")
  else
    puts("Overwriting original file with cleaned version.")
    FileUtils.move(temp_path, file_path)
  end
else
  ImmosquareCleaner.clean(file_path, **options)
end
